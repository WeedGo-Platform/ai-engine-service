# Budtender Domain Data Schema Mapping
# Maps domain concepts to database tables and fields

entities:
  product:
    db_table: products
    id_field: id
    fields:
      # Domain field -> DB field
      id: id
      name: name
      brand: brand
      category: category
      type: plant_type
      strain: strain_name
      thc_content: thc_percentage
      cbd_content: cbd_percentage
      price: price
      description: description
      effects: effects
      medical_benefits: medical_benefits
      flavor_profile: flavor_profile
      terpenes: terpene_profile
      image: image_url
      lab_tested: lab_tested
      batch_number: batch_number
      harvest_date: harvest_date
      available: in_stock
    
    relationships:
      inventory:
        type: one_to_many
        foreign_key: product_id
        target_entity: inventory
      reviews:
        type: one_to_many
        foreign_key: product_id
        target_entity: reviews
      lab_results:
        type: one_to_many
        foreign_key: product_id
        target_entity: lab_results
    
    computed_fields:
      potency_level: |
        CASE 
          WHEN thc_percentage < 10 THEN 'Low'
          WHEN thc_percentage BETWEEN 10 AND 20 THEN 'Medium'
          WHEN thc_percentage > 20 THEN 'High'
        END
      cbd_ratio: |
        CASE
          WHEN cbd_percentage > thc_percentage THEN 'CBD Dominant'
          WHEN cbd_percentage = thc_percentage THEN 'Balanced'
          ELSE 'THC Dominant'
        END

  strain:
    db_table: strains
    id_field: id
    fields:
      id: id
      name: name
      type: strain_type
      genetics: genetics
      thc_average: avg_thc
      cbd_average: avg_cbd
      effects: effects
      medical_uses: medical_uses
      negative_effects: negative_effects
      flavors: flavor_profile
      terpenes: dominant_terpenes
      grow_difficulty: grow_difficulty
      flowering_time: flowering_time
      yield: average_yield
    
    relationships:
      products:
        type: one_to_many
        foreign_key: strain_name
        target_entity: products
      lineage:
        type: many_to_many
        join_table: strain_lineage
        foreign_key: child_strain_id
        related_key: parent_strain_id

  customer:
    db_table: customers
    id_field: id
    fields:
      id: id
      name: full_name
      email: email
      phone: phone_number
      birth_date: date_of_birth
      verified: age_verified
      medical_card: has_medical_card
      medical_expiry: medical_card_expiry
      preferences: preferences
      experience_level: experience_level
      preferred_effects: preferred_effects
      avoid_effects: avoid_effects
      allergies: allergies
      medications: current_medications
    
    relationships:
      orders:
        type: one_to_many
        foreign_key: customer_id
        target_entity: orders
      reviews:
        type: one_to_many
        foreign_key: customer_id
        target_entity: reviews
      consultations:
        type: one_to_many
        foreign_key: customer_id
        target_entity: consultations

  order:
    db_table: orders
    id_field: id
    fields:
      id: id
      customer_id: customer_id
      order_date: created_at
      status: status
      total: total_amount
      tax: tax_amount
      discount: discount_amount
      payment_method: payment_method
      delivery_method: delivery_method
      delivery_address: delivery_address
      notes: order_notes
      
    relationships:
      customer:
        type: many_to_one
        foreign_key: customer_id
        target_entity: customers
      items:
        type: one_to_many
        foreign_key: order_id
        target_entity: order_items

  inventory:
    db_table: inventory
    id_field: id
    fields:
      id: id
      product_id: product_id
      quantity: quantity_available
      location: store_location
      batch: batch_number
      received_date: received_date
      expiry_date: expiry_date
      supplier: supplier_name
      cost: unit_cost
      
    relationships:
      product:
        type: many_to_one
        foreign_key: product_id
        target_entity: products

  consultation:
    db_table: consultations
    id_field: id
    fields:
      id: id
      customer_id: customer_id
      consultant: consultant_name
      date: consultation_date
      symptoms: symptoms_discussed
      recommendations: product_recommendations
      notes: consultation_notes
      follow_up: follow_up_required
      
    relationships:
      customer:
        type: many_to_one
        foreign_key: customer_id
        target_entity: customers

# Query templates for common operations
query_templates:
  find_products_by_effect:
    sql: |
      SELECT * FROM products 
      WHERE effects @> $1::jsonb
      ORDER BY thc_percentage DESC
      LIMIT $2
    
  find_products_by_medical_use:
    sql: |
      SELECT * FROM products 
      WHERE medical_benefits @> $1::jsonb
      ORDER BY cbd_percentage DESC
      LIMIT $2
  
  find_similar_products:
    sql: |
      SELECT * FROM products
      WHERE strain_name IN (
        SELECT name FROM strains
        WHERE strain_type = $1
        AND effects && $2::text[]
      )
      LIMIT $3
  
  get_customer_preferences:
    sql: |
      SELECT preferences, preferred_effects, avoid_effects
      FROM customers
      WHERE id = $1
  
  check_inventory:
    sql: |
      SELECT p.*, i.quantity_available
      FROM products p
      JOIN inventory i ON p.id = i.product_id
      WHERE p.id = $1
      AND i.quantity_available > 0