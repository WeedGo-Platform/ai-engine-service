name: Auto-Sync Dev to Test

# Automatically merge dev branch into test branch on push
# This ensures test environment stays up-to-date with latest dev changes
on:
  push:
    branches:
      - dev
  workflow_dispatch:  # Allow manual trigger

env:
  GIT_AUTHOR_NAME: "GitHub Actions Bot"
  GIT_AUTHOR_EMAIL: "actions@github.com"
  GIT_COMMITTER_NAME: "GitHub Actions Bot"
  GIT_COMMITTER_EMAIL: "actions@github.com"

permissions:
  contents: write

jobs:
  sync-dev-to-test:
    name: Sync Dev â†’ Test Branch
    runs-on: ubuntu-latest

    # Prevent infinite loops if test branch also triggers workflows
    if: github.ref == 'refs/heads/dev'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper merging
          fetch-depth: 0
          # Use a token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "${{ env.GIT_AUTHOR_NAME }}"
          git config --global user.email "${{ env.GIT_AUTHOR_EMAIL }}"

      - name: Fetch all branches
        run: |
          git fetch origin dev
          git fetch origin test

      - name: Checkout test branch
        run: |
          git checkout test
          echo "âœ“ Switched to test branch"

      - name: Check if merge is needed
        id: check_merge
        run: |
          # Check if test already contains all dev commits
          if git merge-base --is-ancestor dev test; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Test branch already contains all dev commits - no merge needed"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "âœ“ Merge needed - dev has new commits"
          fi

      - name: Merge dev into test
        if: steps.check_merge.outputs.skip == 'false'
        run: |
          echo "ðŸ”„ Merging dev into test..."

          # Attempt merge with union strategy for environment files (defined in .gitattributes)
          if git merge dev --no-edit --allow-unrelated-histories -m "chore: Auto-sync dev to test [skip ci]

          Automated merge of dev branch into test branch.

          Changes from dev:
          $(git log test..dev --oneline --max-count=10)

          ðŸ¤– Generated by GitHub Actions
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}"; then
            echo "âœ… Merge successful (no conflicts)"
          else
            # Check if there are conflicts
            if git status | grep -q "Unmerged paths"; then
              echo "âš ï¸  Merge conflicts detected"

              # Show conflicted files
              echo "Conflicted files:"
              git status --short | grep "^UU"

              # For environment files, prefer test branch version
              # This is handled by .gitattributes, but we can also resolve manually
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U)

              for file in $CONFLICT_FILES; do
                echo "Checking conflict in: $file"

                # If it's an environment file or test-specific config, keep test version
                if [[ "$file" =~ \.env\.test$ ]] || \
                   [[ "$file" =~ docker-compose\.test\.yml$ ]] || \
                   [[ "$file" =~ \.env\.test$ ]]; then
                  echo "  â†’ Keeping test branch version for: $file"
                  git checkout --ours "$file"
                  git add "$file"
                else
                  # For other files, this is a real conflict that needs manual resolution
                  echo "  â†’ Real conflict in: $file - requires manual resolution"
                  echo "::error::Merge conflict in $file requires manual resolution"
                  exit 1
                fi
              done

              # Complete the merge
              git commit --no-edit
              echo "âœ… Merge conflicts resolved automatically"
            else
              echo "::error::Merge failed for unknown reason"
              exit 1
            fi
          fi

      - name: Verify test-specific configurations
        if: steps.check_merge.outputs.skip == 'false'
        run: |
          echo "ðŸ” Verifying test-specific configurations..."

          # Check that .env.test exists and has correct port
          if [ -f "src/Backend/.env.test" ]; then
            if grep -q "PORT=6024" src/Backend/.env.test; then
              echo "âœ“ Backend .env.test has correct port (6024)"
            else
              echo "::warning::Backend .env.test may have incorrect port"
            fi
          else
            echo "::warning::Backend .env.test not found"
          fi

          # Check that frontend .env.test exists
          if [ -f "src/Frontend/ai-admin-dashboard/.env.test" ]; then
            if grep -q "6024" src/Frontend/ai-admin-dashboard/.env.test; then
              echo "âœ“ Frontend .env.test has correct API URL"
            else
              echo "::warning::Frontend .env.test may have incorrect API URL"
            fi
          else
            echo "::warning::Frontend .env.test not found"
          fi

          # Check package.json has dev:test script
          if [ -f "src/Frontend/ai-admin-dashboard/package.json" ]; then
            if grep -q '"dev:test"' src/Frontend/ai-admin-dashboard/package.json; then
              echo "âœ“ Frontend package.json has dev:test script"
            else
              echo "::warning::Frontend package.json missing dev:test script"
            fi
          fi

      - name: Push to test branch
        if: steps.check_merge.outputs.skip == 'false'
        run: |
          echo "ðŸ“¤ Pushing merged changes to test branch..."
          git push origin test
          echo "âœ… Successfully pushed to test branch"

      - name: Create merge summary
        if: always()
        run: |
          echo "## ðŸ”„ Dev â†’ Test Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_merge.outputs.skip }}" == "true" ]; then
            echo "**Status:** âœ… Already up-to-date (no merge needed)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test branch already contains all commits from dev." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Merge successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Commits Merged" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git log test~10..test --oneline >> $GITHUB_STEP_SUMMARY || echo "No recent commits" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. The test-deploy workflow will automatically run" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor the build and tests in the test environment" >> $GITHUB_STEP_SUMMARY
          echo "3. Test environment will be available at:" >> $GITHUB_STEP_SUMMARY
          echo "   - Backend: http://localhost:6024 (local)" >> $GITHUB_STEP_SUMMARY
          echo "   - Frontend: http://localhost:6003 (local)" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Dev â†’ Test Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The automatic merge from dev to test encountered an error." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Action Required" >> $GITHUB_STEP_SUMMARY
          echo "Manual intervention is needed to resolve merge conflicts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Manual Merge Steps:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git checkout test" >> $GITHUB_STEP_SUMMARY
          echo "git pull origin test" >> $GITHUB_STEP_SUMMARY
          echo "git merge dev" >> $GITHUB_STEP_SUMMARY
          echo "# Resolve conflicts manually" >> $GITHUB_STEP_SUMMARY
          echo "# Keep test-specific configs (.env.test, package.json dev:test script, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "git add ." >> $GITHUB_STEP_SUMMARY
          echo "git commit" >> $GITHUB_STEP_SUMMARY
          echo "git push origin test" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
